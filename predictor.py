#!/usr/bin/env python
# coding: utf-8

# In[ ]:


# 导入核心库
import streamlit as st
import joblib
import numpy as np
import pandas as pd
import shap
import matplotlib.pyplot as plt
import io
from PIL import Image
from decimal import Decimal, ROUND_HALF_UP  # 新增：精准控制小数精度

# 简化字体配置（仅解决负号显示，无需中文）
plt.rcParams['axes.unicode_minus'] = False
plt.rcParams['figure.dpi'] = 150
plt.rcParams['savefig.dpi'] = 150

# 加载模型
model = joblib.load('GBD.pkl')

# 特征名：医学通用英文缩写
feature_names = [
    "AGE", "ALB", "GLO", "FPG", "SBP", 
    "AST", "DBP", "BUN", "BMI"    
]

# ========== 岗位-指标-阈值建议字典 ==========
job_advice_dict = {
    "机务人员": {
        "BMI": {
            "<18.5": """**低体重（BMI < 18.5）**
            - **饮食建议**：增加蛋白质和总热量摄入。日常多选择鸡蛋、牛奶、鱼、瘦肉等优质蛋白，适当增加坚果、全麦食品等能量密度较高的食物，规律三餐并适当加餐，保证每餐蛋白质+碳水化合物的搭配。
            - **运动建议**：以力量训练为主（自重训练、弹力带训练），每周至少2次，配合适度有氧运动（散步/游泳），增强体能。""",
            "18.5-24": """**正常体重（18.5 ≤ BMI < 24）**
            - **饮食建议**：保持均衡饮食，合理搭配主食、蔬菜水果和优质蛋白，控制油脂和高糖食物摄入，避免暴饮暴食。
            - **运动建议**：每周累计不少于150分钟中等强度有氧运动（快走、骑车），减少久坐，维持心肺功能。""",
            "24-28": """**超重（24 ≤ BMI < 28）**
            - **饮食建议**：适当控制总热量，减少精制碳水（白米饭、白面制品）和油炸、甜食，增加全谷物、蔬菜和优质蛋白比例。
            - **运动建议**：每天不少于30分钟有氧运动，配合每周2次力量训练，提高基础代谢。""",
            "≥28": """**肥胖（BMI ≥ 28）**
            - **饮食建议**：严格控制总能量摄入，减少精制主食、甜食和油炸食品，多选择蔬菜、低脂高蛋白食物（鱼、鸡胸肉、低脂奶）。
            - **运动建议**：身体允许时每天不少于45分钟中等强度有氧运动，结合规律力量训练，促进体重稳定下降。"""
        },
        "ALB": {
            "<40": """**白蛋白偏低（Alb < 40 g/L）**
            - **饮食建议**：增加优质蛋白和总能量摄入，多吃鸡蛋、牛奶、鱼、瘦肉、豆制品，保证主食充足，倒班/夜班后补充奶制品+鸡蛋+主食。
            - **生活运动建议**：避免长期熬夜和高强度值班，保证休息；每周2~3次力量训练+轻中度有氧运动（快走、拉伸），改善代谢。""",
            "40-55": """**白蛋白正常（40 g/L ≤ Alb ≤ 55 g/L）**
            - **饮食建议**：保持均衡饮食，每天摄入适量优质蛋白，避免“只吃主食不吃蛋白”或“零食代替正餐”。
            - **生活运动建议**：规律作息，减少熬夜；每周累计150分钟中等强度有氧运动+简单力量训练，维持身体机能。""",
            ">55": """**白蛋白偏高（Alb > 55 g/L）**
            - **饮食建议**：增加每日饮水量，避免浓茶/咖啡代替白水，饮食清淡均衡，无需刻意增加高蛋白食物。
            - **生活运动建议**：工作期间定时补水，尤其夜班/值守后；适度有氧活动（散步），促进体液循环。"""
        },
        "GLO": {
            "<20": """**球蛋白偏低（Glob < 20 g/L）**
            - **饮食建议**：增加优质蛋白和全面营养，多吃鸡蛋、牛奶、鱼、瘦肉、豆制品，搭配主食和蔬菜水果，避免饮食单一。
            - **生活运动建议**：规律作息，充足睡眠，避免熬夜；每周2~3次适度有氧运动（快走），增强体质。""",
            "20-35": """**球蛋白正常（20 g/L ≤ Glob ≤ 35 g/L）**
            - **饮食建议**：均衡饮食，搭配肉类、蛋类、奶制品、蔬菜和主食，避免偏食或长期高油高糖饮食。
            - **生活运动建议**：规律作息，避免久坐；每周适量有氧活动（快走、骑车），维持身体状态。""",
            ">35": """**球蛋白偏高（Glob > 35 g/L）**
            - **饮食建议**：饮食清淡，减少油腻、辛辣刺激性食物，多吃蔬菜水果，避免重口味饮食加重炎症负担。
            - **生活运动建议**：注意休息，避免疲劳作业；反复偏高建议复查，适当温和有氧运动改善状态。"""
        },
        "FBG": {
            "<6.1": """**空腹血糖正常（FBG < 6.1 mmol/L）**
            - **饮食建议**：规律三餐，控制甜食和含糖饮料，主食粗细搭配，多吃蔬菜。
            - **生活运动建议**：避免久坐，每天适量活动（快走、上下楼梯），维持血糖代谢。""",
            "6.1-7.0": """**空腹血糖偏高（6.1 ≤ FBG < 7.0 mmol/L）**
            - **饮食建议**：减少精制碳水和甜食，控制主食总量，多选择全谷物和蔬菜，避免夜宵和暴饮暴食。
            - **生活运动建议**：每天不少于30分钟中等强度有氧运动（快走），改善胰岛素敏感性。""",
            "≥7.0": """**空腹血糖明显升高（FBG ≥ 7.0 mmol/L）**
            - **饮食建议**：严格控制总能量和糖类摄入，减少米面、甜食和含糖饮料，多吃清淡高纤维饮食。
            - **生活运动建议**：在医生指导下规律运动（快走），避免久坐，建议进一步就医评估。"""
        },
        "AST": {
            "≤40": """**谷草转氨酶正常（AST ≤ 40 U/L）**
            - **饮食建议**：清淡规律饮食，避免长期高油高脂饮食和饮酒，维持肝脏代谢。
            - **生活运动建议**：避免熬夜和过度疲劳，适度有氧运动，维持身体机能。""",
            ">40": """**谷草转氨酶升高（AST > 40 U/L）**
            - **饮食建议**：减少油腻食物和酒精摄入，多吃蔬菜水果，清淡饮食减轻肝脏负担。
            - **生活运动建议**：注意休息，避免过度劳累和剧烈运动，建议复查肝功能相关指标。"""
        },
        "BUN": {
            "<2.9": """**尿素氮偏低（BUN < 2.9 mmol/L）**
            - **饮食建议**：适当增加优质蛋白（鸡蛋、牛奶、鱼、瘦肉），避免饮食过于清淡，保证营养充足。
            - **生活运动建议**：规律作息，避免长期疲劳和过度消耗，改善代谢状态。""",
            "2.9-8.2": """**尿素氮正常（2.9 mmol/L ≤ BUN ≤ 8.2 mmol/L）**
            - **饮食建议**：均衡饮食，蛋白摄入适量，合理搭配主食、蔬菜和肉类。
            - **生活运动建议**：规律饮水，避免久坐，适当日常活动，维持代谢稳定。""",
            ">8.2": """**尿素氮偏高（BUN > 8.2 mmol/L）**
            - **饮食建议**：控制高蛋白饮食，减少大鱼大肉，增加饮水量，饮食清淡减轻肾脏负担。
            - **生活运动建议**：避免疲劳和脱水，多次偏高建议进一步检查肾功能。"""
        },
        "血压": {
            "正常": """**血压正常（SBP < 140 且 DBP < 90 mmHg）**
            - **饮食建议**：清淡饮食，控制盐和油脂摄入，规律进食。
            - **生活运动建议**：避免久坐和精神紧张，每周适量有氧运动（快走）。""",
            "偏高": """**血压偏高（SBP ≥ 140 或 DBP ≥ 90 mmHg）**
            - **饮食建议**：严格控制食盐摄入，减少腌制和高油食物，多吃蔬菜水果。
            - **生活运动建议**：减轻体重、缓解压力，每天不少于30分钟有氧运动，定期监测血压。"""
        }
    },
    "车务人员": {
        "BMI": {
            "<18.5": """**低体重（BMI < 18.5）**
            - **饮食建议**：增加蛋白质和总热量摄入，多选择鸡蛋、牛奶、鱼、瘦肉等优质蛋白，适当增加坚果、全麦食品，规律三餐并加餐。
            - **运动建议**：力量训练为主，配合快走、游泳等有氧运动，每周2次以上，促进肌肉和体力恢复。""",
            "18.5-24": """**正常体重（18.5 ≤ BMI < 24）**
            - **饮食建议**：均衡饮食，搭配主食、蔬菜水果和优质蛋白，控制油脂和高糖食物。
            - **运动建议**：每周累计不少于150分钟中等强度有氧运动，减少久坐，维持体能。""",
            "24-28": """**超重（24 ≤ BMI < 28）**
            - **饮食建议**：控制总热量，减少精制碳水和油炸、甜食，增加全谷物和蔬菜比例。
            - **运动建议**：每天30分钟有氧运动+每周2次力量训练，促进体重控制。""",
            "≥28": """**肥胖（BMI ≥ 28）**
            - **饮食建议**：严格控制总能量，减少精制主食、甜食和油炸食品，多吃蔬菜和低脂高蛋白食物。
            - **运动建议**：身体允许时每天45分钟中等强度有氧运动+规律力量训练，逐步减重。"""
        },
        "ALB": {
            "<40": """**白蛋白偏低（Alb < 40 g/L）**
            - **饮食建议**：增加优质蛋白和总能量，多吃鸡蛋、牛奶、鱼、瘦肉、豆制品，保证主食充足。
            - **生活运动建议**：避免熬夜和疲劳，每周2~3次力量训练+轻中度有氧运动，改善体力。""",
            "40-55": """**白蛋白正常（40 g/L ≤ Alb ≤ 55 g/L）**
            - **饮食建议**：均衡饮食，规律进食，保证每日蛋白摄入。
            - **生活运动建议**：规律作息，适量有氧运动+简单力量训练，维持身体机能。""",
            ">55": """**白蛋白偏高（Alb > 55 g/L）**
            - **饮食建议**：增加饮水量，饮食清淡，无需刻意补蛋白。
            - **生活运动建议**：工作期间定时补水，适度有氧活动促进体液循环。"""
        },
        "GLO": {
            "<20": """**球蛋白偏低（Glob < 20 g/L）**
            - **饮食建议**：全面营养，多吃优质蛋白+主食+蔬菜水果，避免饮食单一。
            - **生活运动建议**：规律作息，充足睡眠，每周2~3次快走等有氧运动，增强抵抗力。""",
            "20-35": """**球蛋白正常（20 g/L ≤ Glob ≤ 35 g/L）**
            - **饮食建议**：均衡饮食，避免偏食或高油高糖饮食。
            - **生活运动建议**：规律作息，避免久坐，每周适量有氧活动维持状态。""",
            ">35": """**球蛋白偏高（Glob > 35 g/L）**
            - **饮食建议**：清淡饮食，减少油腻辛辣食物，多吃蔬菜水果。
            - **生活运动建议**：注意休息，避免疲劳；反复偏高建议复查炎症指标。"""
        },
        "FBG": {
            "<6.1": """**空腹血糖正常（FBG < 6.1 mmol/L）**
            - **饮食建议**：规律三餐，主食粗细搭配，控制甜食和含糖饮料。
            - **生活运动建议**：避免久坐，每周规律有氧运动，维持代谢。""",
            "6.1-7.0": """**空腹血糖偏高（6.1 ≤ FBG < 7.0 mmol/L）**
            - **饮食建议**：减少精制碳水和甜食，控制主食量，多吃全谷物和蔬菜。
            - **生活运动建议**：每天30分钟有氧运动，改善血糖控制。""",
            "≥7.0": """**空腹血糖明显升高（FBG ≥ 7.0 mmol/L）**
            - **饮食建议**：严格控糖和精制主食，清淡高纤维饮食。
            - **生活运动建议**：医生指导下规律运动，尽快就医评估。"""
        },
        "AST": {
            "≤40": """**谷草转氨酶正常（AST ≤ 40 U/L）**
            - **饮食建议**：清淡饮食，避免高油高脂和饮酒，多吃蔬菜水果。
            - **生活运动建议**：规律作息，避免熬夜，适度有氧运动。""",
            ">40": """**谷草转氨酶升高（AST > 40 U/L）**
            - **饮食建议**：减少油腻和酒精，清淡饮食减轻肝脏负担。
            - **生活运动建议**：注意休息，避免熬夜和剧烈运动，复查肝功能。"""
        },
        "BUN": {
            "<2.9": """**尿素氮偏低（BUN < 2.9 mmol/L）**
            - **饮食建议**：增加优质蛋白摄入，避免饮食过于清淡。
            - **生活运动建议**：规律作息，避免长期疲劳，改善代谢。""",
            "2.9-8.2": """**尿素氮正常（2.9 mmol/L ≤ BUN ≤ 8.2 mmol/L）**
            - **饮食建议**：均衡饮食，蛋白摄入适量。
            - **生活运动建议**：规律饮水，适当活动，维持代谢稳定。""",
            ">8.2": """**尿素氮偏高（BUN > 8.2 mmol/L）**
            - **饮食建议**：控制高蛋白饮食，增加饮水量，饮食清淡。
            - **生活运动建议**：避免脱水和疲劳，多次偏高建议查肾功能。"""
        },
        "血压": {
            "正常": """**血压正常（SBP < 140 且 DBP < 90 mmHg）**
            - **饮食建议**：清淡饮食，控盐控油，减少腌制食物。
            - **生活运动建议**：规律作息，避免紧张，每周适量有氧运动。""",
            "偏高": """**血压偏高（SBP ≥ 140 或 DBP ≥ 90 mmHg）**
            - **饮食建议**：严格限盐，减少高油食物，多吃蔬菜水果。
            - **生活运动建议**：减重减压，每天30分钟有氧运动，定期监测血压。"""
        }
    },
    "电务供电人员": {
        "BMI": {
            "<18.5": """**低体重（BMI < 18.5）**
            - **饮食建议**：增加蛋白质和总热量，多吃优质蛋白+坚果+全麦食品，规律三餐加餐，改善体力储备。
            - **运动建议**：力量训练为主，配合快走/游泳，每周2次以上，促进肌肉和体能恢复。""",
            "18.5-24": """**正常体重（18.5 ≤ BMI < 24）**
            - **饮食建议**：均衡饮食，避免饮食不规律，维持体能。
            - **运动建议**：每周150分钟中等强度有氧运动+力量训练，维持作业耐受能力。""",
            "24-28": """**超重（24 ≤ BMI < 28）**
            - **饮食建议**：控制总热量，减少精制碳水和油炸甜食，增加全谷物和蔬菜。
            - **运动建议**：每天30分钟有氧运动+每周2次力量训练，减轻作业负担。""",
            "≥28": """**肥胖（BMI ≥ 28）**
            - **饮食建议**：严格控能，减少精制主食和油炸食品，多吃蔬菜和低脂蛋白。
            - **运动建议**：身体允许时每天45分钟有氧运动+力量训练，降低作业风险。"""
        },
        "ALB": {
            "<40": """**白蛋白偏低（Alb < 40 g/L）**
            - **饮食建议**：重点补充优质蛋白和能量，多吃鸡蛋、牛奶、鱼、瘦肉，保证主食充足，避免野外作业凑合吃饭。
            - **生活运动建议**：保证休息，避免连续高强度作业；每周2~3次力量训练+轻有氧运动，改善体能合成。""",
            "40-55": """**白蛋白正常（40 g/L ≤ Alb ≤ 55 g/L）**
            - **饮食建议**：保持均衡饮食，稳定蛋白和主食摄入，避免作业环境影响饮食质量。
            - **生活运动建议**：规律作息，适量运动，维持体力储备。""",
            ">55": """**白蛋白偏高（Alb > 55 g/L）**
            - **饮食建议**：增加饮水量，尤其高温作业后及时补水，饮食清淡。
            - **生活运动建议**：作业中分次补水，适度有氧活动促进体液循环。"""
        },
        "GLO": {
            "<20": """**球蛋白偏低（Glob < 20 g/L）**
            - **饮食建议**：全面营养，搭配肉蛋奶豆制品+蔬菜水果，避免饮食单一导致抵抗力下降。
            - **生活运动建议**：充足睡眠，避免疲劳作业；每周2~3次快走等有氧运动，改善免疫。""",
            "20-35": """**球蛋白正常（20 g/L ≤ Glob ≤ 35 g/L）**
            - **饮食建议**：均衡饮食，避免偏食或高油高糖饮食。
            - **生活运动建议**：规律作息，适量活动，维持身体状态。""",
            ">35": """**球蛋白偏高（Glob > 35 g/L）**
            - **饮食建议**：清淡饮食，减少油腻辛辣，多吃蔬菜水果。
            - **生活运动建议**：注意休息，避免带病作业；反复偏高建议查慢性炎症。"""
        },
        "FBG": {
            "<6.1": """**空腹血糖正常（FBG < 6.1 mmol/L）**
            - **饮食建议**：规律三餐，主食粗细搭配，控制甜食，避免饥一顿饱一顿。
            - **生活运动建议**：避免久坐，保持日常活动量，规律有氧运动。""",
            "6.1-7.0": """**空腹血糖偏高（6.1 ≤ FBG < 7.0 mmol/L）**
            - **饮食建议**：减少精制碳水和夜宵，控制主食量，多吃全谷物和蔬菜，避免高糖零食加班补给。
            - **生活运动建议**：每天30分钟有氧运动，改善胰岛素敏感性。""",
            "≥7.0": """**空腹血糖明显升高（FBG ≥ 7.0 mmol/L）**
            - **饮食建议**：严格控糖和精制主食，清淡高纤维饮食。
            - **生活运动建议**：医生指导下运动，避免带病高强度作业，尽快就医。"""
        },
        "AST": {
            "≤40": """**谷草转氨酶正常（AST ≤ 40 U/L）**
            - **饮食建议**：清淡饮食，避免高油高脂和饮酒，减轻肝脏负担。
            - **生活运动建议**：避免熬夜和疲劳，适度有氧运动，维持身体状态。""",
            ">40": """**谷草转氨酶升高（AST > 40 U/L）**
            - **饮食建议**：减少油腻和酒精，多吃蔬菜水果，清淡饮食。
            - **生活运动建议**：注意休息，避免高强度作业，复查肝功能调整作业强度。"""
        },
        "BUN": {
            "<2.9": """**尿素氮偏低（BUN < 2.9 mmol/L）**
            - **饮食建议**：增加优质蛋白，避免饮食过于清淡或食量不足。
            - **生活运动建议**：规律作息，避免高消耗状态，改善代谢。""",
            "2.9-8.2": """**尿素氮正常（2.9 mmol/L ≤ BUN ≤ 8.2 mmol/L）**
            - **饮食建议**：均衡饮食，蛋白适量，作业期间合理补水。
            - **生活运动建议**：避免久坐，适量活动，维持代谢。""",
            ">8.2": """**尿素氮偏高（BUN > 8.2 mmol/L）**
            - **饮食建议**：控制高蛋白饮食，增加饮水量，饮食清淡。
            - **生活运动建议**：避免脱水和疲劳作业，多次偏高查肾功能。"""
        },
        "血压": {
            "正常": """**血压正常（SBP < 140 且 DBP < 90 mmHg）**
            - **饮食建议**：清淡饮食，控盐控油，减少腌制食物。
            - **生活运动建议**：规律作息，避免紧张，适量有氧运动。""",
            "偏高": """**血压偏高（SBP ≥ 140 或 DBP ≥ 90 mmHg）**
            - **饮食建议**：严格限盐，减少高油食物，多吃蔬菜水果。
            - **生活运动建议**：减重减压，每天30分钟有氧运动，定期监测血压，必要时就医。"""
        }
    },
    "工务人员": {
        "BMI": {
            "<18.5": """**低体重（BMI < 18.5）**
            - **饮食建议**：明显增加总能量和优质蛋白，三餐基础上增加鸡蛋、牛奶、鱼、瘦肉，搭配主食和坚果，避免干得多补得少。
            - **运动建议**：保证休息，逐步增加抗阻训练+适度有氧运动，每周2~3次，提高高强度作业耐受能力。""",
            "18.5-24": """**正常体重（18.5 ≤ BMI < 24）**
            - **饮食建议**：保持均衡饮食，稳定主食、蔬菜和优质蛋白摄入，避免施工环境影响饮食质量。
            - **运动建议**：规律作息，结合拉伸和力量训练，维持作业耐力。""",
            "24-28": """**超重（24 ≤ BMI < 28）**
            - **饮食建议**：控制总能量，减少精制碳水、油炸食品，主食粗细搭配，保证蛋白摄入。
            - **运动建议**：日常体力劳动基础上，增加快走等有氧运动+每周2次力量训练，减轻关节心肺负担。""",
            "≥28": """**肥胖（BMI ≥ 28）**
            - **饮食建议**：系统控制总能量，减少精制主食和油炸食品，清淡高纤维+适量优质蛋白，逐步减重。
            - **运动建议**：身体允许时每天45分钟有氧运动+力量训练，避免关节损伤，必要时专业指导。"""
        },
        "ALB": {
            "<40": """**白蛋白偏低（Alb < 40 g/L）**
            - **饮食建议**：重点补充优质蛋白和能量，多吃鸡蛋、牛奶、鱼、瘦肉，保证主食充足，避免施工忙凑合吃饭。
            - **生活运动建议**：保证休息恢复，避免连续高强度作业；每周2~3次力量训练+轻有氧运动，改善体能恢复能力。""",
            "40-55": """**白蛋白正常（40 g/L ≤ Alb ≤ 55 g/L）**
            - **饮食建议**：保持均衡饮食，稳定蛋白和主食摄入，避免作业环境降低饮食质量。
            - **生活运动建议**：规律作息，适量运动，维持体力储备。""",
            ">55": """**白蛋白偏高（Alb > 55 g/L）**
            - **饮食建议**：增加饮水量，尤其高温作业后及时补水，饮食清淡均衡。
            - **生活运动建议**：作业中分次补水，适度有氧活动，避免轻度脱水。"""
        },
        "GLO": {
            "<20": """**球蛋白偏低（Glob < 20 g/L）**
            - **饮食建议**：全面营养，搭配肉蛋奶豆制品+蔬菜水果，避免饮食单一导致抵抗力下降。
            - **生活运动建议**：充足睡眠，避免疲劳施工；每周2~3次快走等有氧运动，增强体质。""",
            "20-35": """**球蛋白正常（20 g/L ≤ Glob ≤ 35 g/L）**
            - **饮食建议**：均衡饮食，避免偏食或高油高盐饮食。
            - **生活运动建议**：规律作息，适量活动，维持工作耐力。""",
            ">35": """**球蛋白偏高（Glob > 35 g/L）**
            - **饮食建议**：清淡饮食，减少油腻辛辣，多吃蔬菜水果。
            - **生活运动建议**：注意休息，避免带病作业；反复偏高查慢性炎症。"""
        },
        "FBG": {
            "<6.1": """**空腹血糖正常（FBG < 6.1 mmol/L）**
            - **饮食建议**：规律三餐，主食粗细搭配，控制甜食，避免饥一顿饱一顿。
            - **生活运动建议**：保持日常活动量，规律有氧运动，维持代谢。""",
            "6.1-7.0": """**空腹血糖偏高（6.1 ≤ FBG < 7.0 mmol/L）**
            - **饮食建议**：减少精制碳水和夜宵，控制主食量，多吃全谷物和蔬菜，避免高糖零食加班补给。
            - **生活运动建议**：每天30分钟有氧运动，改善血糖控制。""",
            "≥7.0": """**空腹血糖明显升高（FBG ≥ 7.0 mmol/L）**
            - **饮食建议**：严格控糖和精制主食，清淡高纤维饮食。
            - **生活运动建议**：医生指导下运动，避免带病高强度作业，尽快就医。"""
        },
        "AST": {
            "≤40": """**谷草转氨酶正常（AST ≤ 40 U/L）**
            - **饮食建议**：清淡规律饮食，避免高油高脂和饮酒，减轻肝脏负担。
            - **生活运动建议**：避免熬夜和疲劳，适度拉伸和有氧活动，促进恢复。""",
            ">40": """**谷草转氨酶升高（AST > 40 U/L）**
            - **饮食建议**：减少油腻和酒精，多吃蔬菜水果，清淡饮食。
            - **生活运动建议**：注意休息，避免高强度施工，复查肝功能调整作业强度。"""
        },
        "BUN": {
            "<2.9": """**尿素氮偏低（BUN < 2.9 mmol/L）**
            - **饮食建议**：增加优质蛋白，避免饮食过于清淡或食量不足。
            - **生活运动建议**：规律作息，避免长期高消耗，改善代谢。""",
            "2.9-8.2": """**尿素氮正常（2.9 mmol/L ≤ BUN ≤ 8.2 mmol/L）**
            - **饮食建议**：均衡饮食，蛋白适量，作业期间合理补水。
            - **生活运动建议**：避免久坐，适量活动，维持代谢稳定。""",
            ">8.2": """**尿素氮偏高（BUN > 8.2 mmol/L）**
            - **饮食建议**：控制高蛋白饮食，增加饮水量，饮食清淡。
            - **生活运动建议**：避免脱水和疲劳施工，多次偏高查肾功能。"""
        },
        "血压": {
            "正常": """**血压正常（SBP < 140 且 DBP < 90 mmHg）**
            - **饮食建议**：清淡饮食，控盐控油，减少腌制食物。
            - **生活运动建议**：规律作息，避免过度劳累，适量有氧运动。""",
            "偏高": """**血压偏高（SBP ≥ 140 或 DBP ≥ 90 mmHg）**
            - **饮食建议**：严格限盐，减少高油食物，多吃蔬菜水果。
            - **生活运动建议**：减重减压，每天30分钟有氧运动，定期监测血压，必要时就医。"""
        }
    },
    "行政及其他人员": {
        "BMI": {
            "<18.5": """**低体重（BMI < 18.5）**
            - **饮食建议**：增加总能量和优质蛋白，规律三餐，多吃鸡蛋、牛奶、鱼、瘦肉，搭配主食，避免工作忙饮食不规律。
            - **运动建议**：保证休息，力量训练+适度有氧运动，每周2~3次，增加肌肉量和体力。""",
            "18.5-24": """**正常体重（18.5 ≤ BMI < 24）**
            - **饮食建议**：保持均衡饮食，避免高油高糖零食和含糖饮料，防止久坐导致体重上升。
            - **运动建议**：避免久坐，每天固定活动时间，每周至少150分钟中等强度有氧运动。""",
            "24-28": """**超重（24 ≤ BMI < 28）**
            - **饮食建议**：控制总能量，减少精制碳水、油炸食品和甜食，增加蔬菜和全谷物比例。
            - **运动建议**：每天30分钟有氧运动，逐步增加活动量，减少久坐。""",
            "≥28": """**肥胖（BMI ≥ 28）**
            - **饮食建议**：系统控制总能量，减少精制主食和油炸食品，清淡高纤维+适量优质蛋白，逐步减重。
            - **运动建议**：每天45分钟有氧运动+力量训练，必要时专业指导。"""
        },
        "ALB": {
            "<40": """**白蛋白偏低（Alb < 40 g/L）**
            - **饮食建议**：补充优质蛋白和能量，保证每天鸡蛋、牛奶、鱼、瘦肉摄入，避免不吃早饭或零食替代正餐。
            - **生活运动建议**：调整作息，避免熬夜加班；每周2~3次力量训练+有氧运动，改善机体合成能力。""",
            "40-55": """**白蛋白正常（40 g/L ≤ Alb ≤ 55 g/L）**
            - **饮食建议**：保持均衡饮食，避免工作忙用零食外卖替代正餐，稳定蛋白和主食摄入。
            - **生活运动建议**：规律作息，适量运动，维持营养状态。""",
            ">55": """**白蛋白偏高（Alb > 55 g/L）**
            - **饮食建议**：增加饮水量，久坐办公时主动补水，饮食清淡均衡。
            - **生活运动建议**：每隔1小时起身活动补水，适度有氧活动，避免轻度脱水。"""
        },
        "GLO": {
            "<20": """**球蛋白偏低（Glob < 20 g/L）**
            - **饮食建议**：全面营养，搭配肉蛋奶豆制品+蔬菜水果，避免饮食单一。
            - **生活运动建议**：充足睡眠，减少熬夜，每周2~3次规律运动，增强抵抗力。""",
            "20-35": """**球蛋白正常（20 g/L ≤ Glob ≤ 35 g/L）**
            - **饮食建议**：均衡饮食，避免偏食或高油高糖饮食。
            - **生活运动建议**：规律作息，适量活动，维持免疫状态。""",
            ">35": """**球蛋白偏高（Glob > 35 g/L）**
            - **饮食建议**：清淡饮食，减少油腻辛辣，多吃蔬菜水果。
            - **生活运动建议**：注意休息，避免熬夜；反复偏高查慢性炎症。"""
        },
        "FBG": {
            "<6.1": """**空腹血糖正常（FBG < 6.1 mmol/L）**
            - **饮食建议**：规律三餐，主食粗细搭配，控制甜食和含糖饮料，避免边工作边吃零食。
            - **生活运动建议**：减少久坐，每天固定活动时间，维持代谢。""",
            "6.1-7.0": """**空腹血糖偏高（6.1 ≤ FBG < 7.0 mmol/L）**
            - **饮食建议**：减少精制碳水和甜食，控制主食量，多吃全谷物和蔬菜，避免零食续命。
            - **生活运动建议**：每天30分钟有氧运动，减少连续久坐。""",
            "≥7.0": """**空腹血糖明显升高（FBG ≥ 7.0 mmol/L）**
            - **饮食建议**：严格控糖和精制主食，清淡高纤维饮食。
            - **生活运动建议**：医生指导下规范管理，避免忽视血糖问题。"""
        },
        "AST": {
            "≤40": """**谷草转氨酶正常（AST ≤ 40 U/L）**
            - **饮食建议**：清淡饮食，避免频繁饮酒和高油高脂饮食。
            - **生活运动建议**：避免熬夜，增加规律运动，维持肝脏功能。""",
            ">40": """**谷草转氨酶升高（AST > 40 U/L）**
            - **饮食建议**：减少油腻和酒精，多吃蔬菜水果，清淡饮食。
            - **生活运动建议**：调整作息，减少应酬熬夜，复查肝功能排查脂肪肝。"""
        },
        "BUN": {
            "<2.9": """**尿素氮偏低（BUN < 2.9 mmol/L）**
            - **饮食建议**：增加优质蛋白，避免饮食过于清淡或食量不足。
            - **生活运动建议**：规律作息，避免低摄入低活动状态。""",
            "2.9-8.2": """**尿素氮正常（2.9 mmol/L ≤ BUN ≤ 8.2 mmol/L）**
            - **饮食建议**：均衡饮食，蛋白适量，日常主动补水。
            - **生活运动建议**：避免久坐，适量活动，维持代谢。""",
            ">8.2": """**尿素氮偏高（BUN > 8.2 mmol/L）**
            - **饮食建议**：减少高蛋白饮食，增加饮水量，饮食清淡。
            - **生活运动建议**：避免久坐缺水，多次偏高查肾功能。"""
        },
        "血压": {
            "正常": """**血压正常（SBP < 140 且 DBP < 90 mmHg）**
            - **饮食建议**：清淡饮食，控盐控油，减少外卖和腌制食品。
            - **生活运动建议**：避免久坐和精神紧张，规律有氧运动。""",
            "偏高": """**血压偏高（SBP ≥ 140 或 DBP ≥ 90 mmHg）**
            - **饮食建议**：严格限盐，减少高油食物，多吃蔬菜水果。
            - **生活运动建议**：减重减压，每天30分钟有氧运动，定期监测血压，必要时就医。"""
        }
    }
}

# 岗位名称映射
job_name_map = {
    0: "机务人员",
    1: "车务人员",
    2: "电务供电人员",
    3: "工务人员",
    4: "行政及其他人员"
}

# StreamLit界面（输入框保留中文+英文缩写）
st.title("动脉硬化预测器")

# 输入框
job_code = st.selectbox("岗位：", options=[0, 1, 2, 3, 4], format_func=lambda x: job_name_map[x])
AGE = st.number_input("年龄(Age):", min_value=0, max_value=120, value=0)
ALB = st.number_input("白蛋白(ALB):", min_value=0, max_value=70, value=0, step=1)
GLO = st.number_input("球蛋白(GLO):", min_value=0, max_value=70, value=0, step=1)
FBG = st.number_input("空腹血糖(FBG):", min_value=0.0, max_value=20.0, value=0.0, step=0.1)
SBP = st.number_input("收缩压(SBP):", min_value=0.0, max_value=200.0, value=0.0, step=0.1)
AST = st.number_input("谷草转氨酶(AST):", min_value=0, max_value=500, value=0, step=1)
DBP = st.number_input("舒张压(DBP):", min_value=0.0, max_value=200.0, value=0.0, step=0.1)
BUN = st.number_input("血清尿素氮(BUN):", min_value=0, max_value=50, value=0)
BMI = st.number_input("体质指数(BMI):", min_value=0, max_value=50, value=0)


# 处理输入数据（核心：用Decimal精准控制2位小数）
feature_values = [
    AGE, ALB, GLO, FBG, SBP, AST, DBP, BUN, BMI
]  
# 彻底解决浮点误差：用Decimal保留2位小数
feature_values = [
    float(Decimal(str(x)).quantize(Decimal('0.00'), rounding=ROUND_HALF_UP)) 
    for x in feature_values
]
# 转为numpy数组（供模型预测）
features = np.array([feature_values], dtype=np.float32)

# 构建两个DataFrame：
# 1. 模型预测用（数值型，精准）
features_df = pd.DataFrame(features, columns=feature_names, dtype=np.float32)
# 2. SHAP显示用（字符串型，格式化后无超长小数）
formatted_features = {col: f"{val:.2f}" for col, val in zip(feature_names, feature_values)}
formatted_values = [formatted_features[col] for col in feature_names]
features_df_display = pd.DataFrame([formatted_values], columns=feature_names)

# 预测逻辑
if st.button("Predict"):
    predicted_class = model.predict(features)[0]
    predicted_proba = model.predict_proba(features)[0]

    # 显示预测结果
    st.write(f"**预测类别:** {predicted_class} (1: 有动脉硬化, 0: 无动脉硬化)")
    st.write(f"**预测概率:** {predicted_proba}")

    # 生成风险建议
    probability = predicted_proba[predicted_class] * 100
    if predicted_class == 1:
        advice = (
            f"根据模型预测，你有较高的动脉硬化风险。"
            f"模型预测你患有动脉硬化的概率为 {probability:.1f}%。"
            "建议及时咨询医生，进行进一步检查和干预。"
        )
    else:
        advice = (
            f"根据模型预测，你患动脉硬化的风险较低。"
            f"模型预测你无动脉硬化的概率为 {probability:.1f}%。"
            "建议保持健康的生活方式，并定期进行体检。"
        )
    st.write(advice)

    # ========== 分岗位-分指标个性化建议 ==========
    st.subheader(f"📋 {job_name_map[job_code]} 个性化健康建议")
    current_job = job_name_map[job_code]
    job_advice = job_advice_dict[current_job]

    # 1. BMI建议
    st.markdown("### 📊 体质指数（BMI）建议")
    if BMI < 18.5:
        st.markdown(job_advice["BMI"]["<18.5"])
    elif 18.5 <= BMI < 24:
        st.markdown(job_advice["BMI"]["18.5-24"])
    elif 24 <= BMI < 28:
        st.markdown(job_advice["BMI"]["24-28"])
    else:
        st.markdown(job_advice["BMI"]["≥28"])

    # 2. 白蛋白（ALB）建议
    st.markdown("### 🩸 白蛋白（ALB）建议")
    if ALB < 40:
        st.markdown(job_advice["ALB"]["<40"])
    elif 40 <= ALB <= 55:
        st.markdown(job_advice["ALB"]["40-55"])
    else:
        st.markdown(job_advice["ALB"][">55"])

    # 3. 球蛋白（GLO）建议
    st.markdown("### 🛡️ 球蛋白（GLO）建议")
    if GLO < 20:
        st.markdown(job_advice["GLO"]["<20"])
    elif 20 <= GLO <= 35:
        st.markdown(job_advice["GLO"]["20-35"])
    else:
        st.markdown(job_advice["GLO"][">35"])

    # 4. 空腹血糖（FBG）建议
    st.markdown("### 🍬 空腹血糖（FBG）建议")
    if FBG < 6.1:
        st.markdown(job_advice["FBG"]["<6.1"])
    elif 6.1 <= FBG < 7.0:
        st.markdown(job_advice["FBG"]["6.1-7.0"])
    else:
        st.markdown(job_advice["FBG"]["≥7.0"])

    # 5. 谷草转氨酶（AST）建议
    st.markdown("### 肝 谷草转氨酶（AST）建议")
    if AST <= 40:
        st.markdown(job_advice["AST"]["≤40"])
    else:
        st.markdown(job_advice["AST"][">40"])

    # 6. 尿素氮（BUN）建议
    st.markdown("### 🧪 血清尿素氮（BUN）建议")
    if BUN < 2.9:
        st.markdown(job_advice["BUN"]["<2.9"])
    elif 2.9 <= BUN <= 8.2:
        st.markdown(job_advice["BUN"]["2.9-8.2"])
    else:
        st.markdown(job_advice["BUN"][">8.2"])

    # 7. 血压建议
    st.markdown("### 🩺 血压（SBP/DBP）建议")
    if SBP < 140 and DBP < 90:
        st.markdown(job_advice["血压"]["正常"])
    else:
        st.markdown(job_advice["血压"]["偏高"])

    # ========== SHAP图（使用格式化后的DataFrame，数值显示为2位小数） ==========
    st.subheader("预测结果解释（SHAP Force Plot）")
    plt.clf()
    plt.close('all')
    
    # 计算SHAP值（用模型预测用的features_df）
    explainer = shap.TreeExplainer(model)
    shap_values = explainer.shap_values(features_df)
    if isinstance(shap_values, list) and len(shap_values) == 2:
        shap_values = shap_values[1]
    
    # 生成SHAP Force Plot（用显示用的features_df_display）
    shap.force_plot(
        explainer.expected_value[1] if isinstance(explainer.expected_value, list) else explainer.expected_value,
        shap_values[0],
        features_df_display.iloc[0],  # 关键：用格式化后的字符串数值
        feature_names=feature_names,
        out_names="Fatty Liver Probability",
        show=False,
        matplotlib=True,
        figsize=(12, 4)
    )
    plt.tight_layout()
    
    # 保存并显示图片
    buf = io.BytesIO()
    plt.savefig(buf, format='png', bbox_inches='tight', dpi=150)
    buf.seek(0)
    img = Image.open(buf)
    st.image(img, use_column_width=True)
    plt.close('all')
    
    # 特征缩写对照表
    st.subheader("特征缩写对照表")
    abbr_map = {
        "Age": "年龄", 
        "ALB": "白蛋白",
        "GLO": "球蛋白", 
        "FBG": "空腹血糖", 
        "SBP": "收缩压",   
        "AST": "谷草转氨酶", 
        "DBP": "舒张压", 
        "BUN": "血清尿素氮", 
        "BMI": "体质指数"
    }
    abbr_df = pd.DataFrame({
        "英文缩写": list(abbr_map.keys()),
        "中文含义": list(abbr_map.values())
    })
    st.dataframe(abbr_df, use_container_width=True)
    
    # SHAP图说明
    st.write("""
    **SHAP Force Plot说明：**
    - 红色特征：增加动脉硬化患病概率；
    - 蓝色特征：降低动脉硬化患病概率；
    - 特征条长度：对预测结果的影响程度（越长影响越大）。
    """)

